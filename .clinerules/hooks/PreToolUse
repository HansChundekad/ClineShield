#!/bin/bash
#
# ClineShield PreToolUse Hook - Phase 1
#
# Executes before any tool is used (read_file, write_to_file, execute_command, etc.)
#
# Input: { taskId, preToolUse: { tool: string, parameters: object }, ... }
# Output: { cancel: boolean, contextModification?: string, errorMessage?: string }
#
# Phase 1: Detection & Logging
# - Detect edit_file operations
# - Log file paths and content changes
# - Prepare for Phase 2 AST analysis integration
#
# CRITICAL: Must exit 0 always (hook errors break Cline workflow)

# Read JSON input from stdin
INPUT=$(cat)

# Ensure jq is available (required for robust JSON parsing)
if ! command -v jq &> /dev/null; then
  echo "[ClineShield] WARNING: jq not found, hook disabled" >&2
  echo '{"cancel":false}'
  exit 0
fi

# Parse tool and parameters
TOOL=$(echo "$INPUT" | jq -r '.preToolUse.toolName // "unknown"')

# Log all tool usage (with timestamp for visibility)
LOG_FILE="/tmp/clineshield-hook.log"
echo "===========================================" | tee -a "$LOG_FILE" >&2
echo "[ClineShield] $(date '+%H:%M:%S') - Tool: $TOOL" | tee -a "$LOG_FILE" >&2
echo "[ClineShield] DEBUG: Full input JSON:" | tee -a "$LOG_FILE" >&2
echo "$INPUT" | jq '.' | tee -a "$LOG_FILE" >&2
echo "===========================================" | tee -a "$LOG_FILE" >&2

# Handle file edit operations (apply_patch)
if [[ "$TOOL" == "apply_patch" ]]; then
  # Extract patch input
  PATCH_INPUT=$(echo "$INPUT" | jq -r '.preToolUse.parameters.input // ""')

  # Extract file path from patch (format: "*** Update File: path")
  FILE_PATH=$(echo "$PATCH_INPUT" | grep "^\*\*\* Update File:" | sed 's/\*\*\* Update File: //' | head -1)

  echo "[ClineShield] === APPLY_PATCH DETECTED ===" | tee -a "$LOG_FILE" >&2
  echo "[ClineShield] File: $FILE_PATH" | tee -a "$LOG_FILE" >&2

  # Phase 2: AST Analysis Integration
  # Only analyze TypeScript/JavaScript files
  if [[ "$FILE_PATH" =~ \.(ts|tsx|js|jsx)$ ]] && [[ -f "$FILE_PATH" ]]; then
    # For apply_patch, we need to:
    # - Read current file content as "before"
    # - Apply patch to get "after" content

    # Create temp files
    TEMP_BEFORE="/tmp/clineshield-before-$$.ts"
    TEMP_AFTER="/tmp/clineshield-after-$$.ts"
    PATCH_FILE="/tmp/clineshield-patch-$$.patch"

    # Ensure cleanup on exit
    trap "rm -f '$TEMP_BEFORE' '$TEMP_AFTER' '$PATCH_FILE'" EXIT

    # Read current file as "before"
    cp "$FILE_PATH" "$TEMP_BEFORE"

    # Extract the actual patch content (skip headers, get the diff)
    echo "$PATCH_INPUT" | sed -n '/^@@/,/\*\*\* End Patch/p' | grep -v "^\*\*\*" > "$PATCH_FILE"

    # Apply patch to create "after" version
    cp "$TEMP_BEFORE" "$TEMP_AFTER"
    if patch -s "$TEMP_AFTER" "$PATCH_FILE" 2>/dev/null; then
      echo "[ClineShield] Patch applied successfully" | tee -a "$LOG_FILE" >&2
    else
      echo "[ClineShield] Warning: Patch may not apply cleanly" | tee -a "$LOG_FILE" >&2
    fi

    # Find the analyzer script (relative to hook location)
    ANALYZER_PATH="$(dirname "$0")/../../clineshield/src/hooks/clineshield-analyze.js"

    if [[ -f "$ANALYZER_PATH" ]]; then
      # Run AST analyzer
      echo "[ClineShield] Running AST analysis..." | tee -a "$LOG_FILE" >&2
      ANALYSIS_RESULT=$(node "$ANALYZER_PATH" "$TEMP_BEFORE" "$TEMP_AFTER" 2>/dev/null)

      if [[ $? -eq 0 ]]; then
        # Parse results
        STRUCTURAL_CHANGE=$(echo "$ANALYSIS_RESULT" | jq -r '.structuralChangePercent // 0')
        DELETED_FUNCTIONS=$(echo "$ANALYSIS_RESULT" | jq -r '.deletedFunctions // 0')
        DELETED_EXPORTS=$(echo "$ANALYSIS_RESULT" | jq -r '.deletedExports // 0')

        echo "[ClineShield] === ANALYSIS RESULTS ===" | tee -a "$LOG_FILE" >&2
        echo "[ClineShield] Structural change: ${STRUCTURAL_CHANGE}%" | tee -a "$LOG_FILE" >&2
        echo "[ClineShield] Deleted functions: $DELETED_FUNCTIONS" | tee -a "$LOG_FILE" >&2
        echo "[ClineShield] Deleted exports: $DELETED_EXPORTS" | tee -a "$LOG_FILE" >&2

        # Phase 2: Log only (no blocking yet)
        # Phase 3 will add threshold-based blocking
        if [[ $STRUCTURAL_CHANGE -gt 50 ]]; then
          echo "[ClineShield] ⚠️  WARNING: Large structural change (>${STRUCTURAL_CHANGE}%)" | tee -a "$LOG_FILE" >&2
        fi
        if [[ $DELETED_FUNCTIONS -gt 3 ]]; then
          echo "[ClineShield] ⚠️  WARNING: Multiple functions deleted ($DELETED_FUNCTIONS)" | tee -a "$LOG_FILE" >&2
        fi
      else
        echo "[ClineShield] Analysis failed, allowing edit" | tee -a "$LOG_FILE" >&2
      fi
    else
      echo "[ClineShield] Analyzer not found at: $ANALYZER_PATH" | tee -a "$LOG_FILE" >&2
    fi
  else
    echo "[ClineShield] Skipping analysis (not a TS/JS file)" >&2
  fi
fi

# Handle file write operations
if [[ "$TOOL" == "write_to_file" ]]; then
  FILE_PATH=$(echo "$INPUT" | jq -r '.preToolUse.parameters.file_path // "unknown"')
  CONTENT=$(echo "$INPUT" | jq -r '.preToolUse.parameters.content // ""')
  CONTENT_SIZE=${#CONTENT}

  echo "[ClineShield] === WRITE_FILE DETECTED ===" >&2
  echo "[ClineShield] File: $FILE_PATH" >&2
  echo "[ClineShield] Content size: $CONTENT_SIZE chars" >&2
  echo "[ClineShield] Phase 1: Logging only (new file creation)" >&2
fi

# Handle dangerous commands (existing protection)
if [[ "$TOOL" == "execute_command" ]]; then
  COMMAND=$(echo "$INPUT" | jq -r '.preToolUse.parameters.command // ""')

  # Block destructive operations
  if [[ "$COMMAND" == *"rm -rf /"* ]] || [[ "$COMMAND" == *"sudo rm"* ]]; then
    echo "[ClineShield] BLOCKED: Dangerous command detected" >&2
    echo '{"cancel":true,"errorMessage":"⛔ ClineShield: Dangerous command blocked"}'
    exit 0
  fi
fi

# Allow execution (Phase 1: no blocking on edits)
echo '{"cancel":false}'
exit 0
