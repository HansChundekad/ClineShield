#!/bin/bash
#
# ClineShield PreToolUse Hook - Phase 2
#
# Executes before any tool is used (read_file, write_to_file, execute_command, etc.)
#
# Input: { taskId, preToolUse: { tool: string, parameters: object }, ... }
# Output: { cancel: boolean, contextModification?: string, errorMessage?: string }
#
# Phase 2: Direct Patch Analysis
# - Parse Cline's custom patch format (no patch command needed)
# - Count added/deleted lines and functions
# - Calculate structural change percentage
# - Log warnings for large changes (>50%) or deletions (>3 functions)
#
# CRITICAL: Must exit 0 always (hook errors break Cline workflow)

# Read JSON input from stdin
INPUT=$(cat)

# Ensure jq is available (required for robust JSON parsing)
if ! command -v jq &> /dev/null; then
  echo "[ClineShield] WARNING: jq not found, hook disabled" >&2
  echo '{"cancel":false}'
  exit 0
fi

# Parse tool and parameters
TOOL=$(echo "$INPUT" | jq -r '.preToolUse.toolName // "unknown"')

# Log all tool usage (with timestamp for visibility)
LOG_FILE="/tmp/clineshield-hook.log"
echo "===========================================" | tee -a "$LOG_FILE" >&2
echo "[ClineShield] $(date '+%H:%M:%S') - Tool: $TOOL" | tee -a "$LOG_FILE" >&2
echo "[ClineShield] DEBUG: Full input JSON:" | tee -a "$LOG_FILE" >&2
echo "$INPUT" | jq '.' | tee -a "$LOG_FILE" >&2
echo "===========================================" | tee -a "$LOG_FILE" >&2

# Handle file edit operations (apply_patch)
if [[ "$TOOL" == "apply_patch" ]]; then
  # Extract patch input
  PATCH_INPUT=$(echo "$INPUT" | jq -r '.preToolUse.parameters.input // ""')

  # Extract file path from patch (format: "*** Update File: path")
  FILE_PATH=$(echo "$PATCH_INPUT" | grep "^\*\*\* Update File:" | sed 's/\*\*\* Update File: //' | head -1)

  echo "[ClineShield] === APPLY_PATCH DETECTED ===" | tee -a "$LOG_FILE" >&2
  echo "[ClineShield] File: $FILE_PATH" | tee -a "$LOG_FILE" >&2

  # Phase 2: Parse Cline's patch format directly (no patch command needed)
  # Only analyze TypeScript/JavaScript files
  if [[ "$FILE_PATH" =~ \.(ts|tsx|js|jsx)$ ]]; then
    echo "[ClineShield] Analyzing patch directly..." | tee -a "$LOG_FILE" >&2

    # Initialize counters
    DELETED_LINES=0
    ADDED_LINES=0
    CONTEXT_LINES=0
    DELETED_FUNCTIONS=0
    ADDED_FUNCTIONS=0

    # Function signature patterns (grep -E compatible)
    # Matches: function foo(), async function foo(), foo(), foo(): Type {, async foo(), const foo = () =>
    FUNC_PATTERN='(function\s+\w+\s*\(|^\s*(async\s+)?\w+\s*\([^)]*\)\s*(:|{)|const\s+\w+\s*=\s*.*=>)'

    # Parse patch line by line
    while IFS= read -r line; do
      # Skip patch markers
      if [[ "$line" =~ ^\*\*\*|^@@ ]]; then
        continue
      fi

      # Count deletions
      if [[ "$line" =~ ^- ]]; then
        ((DELETED_LINES++))
        # Strip the '-' prefix and check if line contains a function signature
        line_content="${line:1}"
        if echo "$line_content" | grep -qE "$FUNC_PATTERN"; then
          ((DELETED_FUNCTIONS++))
          echo "[ClineShield] Deleted function: ${line:0:80}" | tee -a "$LOG_FILE" >&2
        fi
      # Count additions
      elif [[ "$line" =~ ^\+ ]]; then
        ((ADDED_LINES++))
        # Strip the '+' prefix and check if line contains a function signature
        line_content="${line:1}"
        if echo "$line_content" | grep -qE "$FUNC_PATTERN"; then
          ((ADDED_FUNCTIONS++))
          echo "[ClineShield] Added function: ${line:0:80}" | tee -a "$LOG_FILE" >&2
        fi
      # Count context lines (start with space)
      elif [[ "$line" =~ ^[[:space:]] ]]; then
        ((CONTEXT_LINES++))
      fi
    done <<< "$PATCH_INPUT"

    # Calculate structural change percentage
    TOTAL_CHANGED=$((DELETED_LINES + ADDED_LINES))
    TOTAL_LINES=$((TOTAL_CHANGED + CONTEXT_LINES))

    if [[ $TOTAL_LINES -gt 0 ]]; then
      STRUCTURAL_CHANGE=$(( (TOTAL_CHANGED * 100) / TOTAL_LINES ))
    else
      STRUCTURAL_CHANGE=0
    fi

    echo "[ClineShield] === ANALYSIS RESULTS ===" | tee -a "$LOG_FILE" >&2
    echo "[ClineShield] Structural change: ${STRUCTURAL_CHANGE}% (${TOTAL_CHANGED}/${TOTAL_LINES} lines)" | tee -a "$LOG_FILE" >&2
    echo "[ClineShield] Added: ${ADDED_LINES} lines, ${ADDED_FUNCTIONS} functions" | tee -a "$LOG_FILE" >&2
    echo "[ClineShield] Deleted: ${DELETED_LINES} lines, ${DELETED_FUNCTIONS} functions" | tee -a "$LOG_FILE" >&2

    # Phase 2: Log only (no blocking yet)
    # Phase 3 will add threshold-based blocking
    if [[ $STRUCTURAL_CHANGE -gt 50 ]]; then
      echo "[ClineShield] ⚠️  WARNING: Large structural change (${STRUCTURAL_CHANGE}%)" | tee -a "$LOG_FILE" >&2
    fi
    if [[ $DELETED_FUNCTIONS -gt 3 ]]; then
      echo "[ClineShield] ⚠️  WARNING: Multiple functions deleted ($DELETED_FUNCTIONS)" | tee -a "$LOG_FILE" >&2
    fi
  else
    echo "[ClineShield] Skipping analysis (not a TS/JS file)" | tee -a "$LOG_FILE" >&2
  fi
fi

# Handle file write operations
if [[ "$TOOL" == "write_to_file" ]]; then
  FILE_PATH=$(echo "$INPUT" | jq -r '.preToolUse.parameters.file_path // "unknown"')
  CONTENT=$(echo "$INPUT" | jq -r '.preToolUse.parameters.content // ""')
  CONTENT_SIZE=${#CONTENT}

  echo "[ClineShield] === WRITE_FILE DETECTED ===" >&2
  echo "[ClineShield] File: $FILE_PATH" >&2
  echo "[ClineShield] Content size: $CONTENT_SIZE chars" >&2
  echo "[ClineShield] Phase 1: Logging only (new file creation)" >&2
fi

# Handle dangerous commands (existing protection)
if [[ "$TOOL" == "execute_command" ]]; then
  COMMAND=$(echo "$INPUT" | jq -r '.preToolUse.parameters.command // ""')

  # Block destructive operations
  if [[ "$COMMAND" == *"rm -rf /"* ]] || [[ "$COMMAND" == *"sudo rm"* ]]; then
    echo "[ClineShield] BLOCKED: Dangerous command detected" >&2
    echo '{"cancel":true,"errorMessage":"⛔ ClineShield: Dangerous command blocked"}'
    exit 0
  fi
fi

# Allow execution (Phase 1: no blocking on edits)
echo '{"cancel":false}'
exit 0
